<main class="product-detail-wrapper">

  <!-- LEFT — PRODUCT IMAGE + BACK LINK -->
  <div class="product-detail-left">
    <a href="/products" class="back-to-products">← Back to Products</a>

    <img 
      src="<%= product.imageUrl || '/images/placeholder-shoe.jpg' %>" 
      alt="<%= product.name %>"
      class="product-main-image"
    >
  </div>

  <!-- RIGHT — PRODUCT INFO -->
  <div class="product-detail-right">

    <!-- BREADCRUMBS -->
    <nav class="breadcrumbs">
      <a href="/">Home</a>
      <span>›</span>
      <a href="/products">Shoes</a>
      <span>›</span>
      <span class="current"><%= product.name %></span>
    </nav>

    <!-- HEADER -->
    <div class="product-header">
      <h1 class="product-title"><%= product.name %></h1>
      <p class="product-brand-display"><%= product.brand %></p>
      <p class="product-price-display">₱<%= product.price.toLocaleString() %></p>
    </div>

    <% 
      let sizes = product.sizes && product.sizes.length
        ? product.sizes
        : ['US 6','US 6.5','US 7','US 7.5','US 8','US 8.5','US 9'].map(s => ({
            label: s,
            stock: product.stock || 0
          }));
    %>

    <!-- SIZE SELECTOR — USERS / GUESTS ONLY -->
    <% if (!user || user.role === "customer") { %>
    <div class="size-block">
      <p class="label">Size</p>

      <div class="size-options">
        <% sizes.forEach(s => { %>
          <button
            type="button"
            class="size-option <%= s.stock <= 0 ? 'size-disabled' : '' %>"
            data-size="<%= s.label %>"
            <%= s.stock <= 0 ? 'disabled' : '' %>
          >
            <%= s.label %>
            <% if (s.stock <= 0) { %>
              <span style="text-decoration: line-through; opacity:.7;font-weight:bold;">X</span>
            <% } %>
          </button>
        <% }) %>
      </div>

      <p class="selected-size-text">Selected size: None</p>
    </div>
    <% } %>

    <!-- ADMIN VIEW -->
    <% if (user && user.role === "admin") { %>
    <div class="size-block admin-size-block">
      <p class="label">Sizes & Stock</p>

      <table class="admin-size-table">
        <thead>
          <tr>
            <th>Size</th>
            <th>Stock</th>
          </tr>
        </thead>
        <tbody>
          <% sizes.forEach(s => { %>
            <tr>
              <td><%= s.label %></td>
              <td><%= s.stock %> pcs</td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } %>

    <!-- SKU -->
    <div class="style-block">
      <p class="label">Style</p>
      <span class="style-value"><%= product.productId %></span>
    </div>

    <% if (product.stock > 0) { %>
      <p class="stock-msg">Only <%= product.stock %> piece(s) left!</p>
    <% } %>

    <!-- ADD TO CART + PROCEED CHECKOUT -->
    <% if ((!user || user.role === "customer") && product.stock > 0) { %>
      <form id="addToCartForm" class="cart-section">
        <input type="hidden" name="productId" value="<%= product.productId %>">
        <input type="hidden" name="size" id="selectedSize" value="">
        
        <label>Quantity:</label>
        <div class="qty-container">
            <input 
              type="number"
              name="quantity" 
              value="1"
              min="1"
              max="<%= product.stock %>"
              class="qty-input">
        </div>

        <div class="cart-action-buttons">
          <button type="submit" class="btn-primary add-cart-btn">ADD TO CART</button>

          <button 
            type="button" 
            id="proceedCheckoutBtn"
            class="proceed-checkout-btn"
            style="white-space:nowrap;">
            Proceed to Checkout
          </button>
        </div>
      </form>
    <% } %>

    <!-- CUSTOMER TABS -->
    <div class="product-tabs">
      <button class="tab active" data-tab="desc">Description</button>
      <button class="tab" data-tab="shipping">Shipping</button>
      <button class="tab" data-tab="returns">Returns</button>
    </div>

    <div class="tab-content active" id="desc">
      <p><%= product.description %></p>
    </div>

    <div class="tab-content" id="shipping">
      <p><%- shippingInfoDefault %></p>
    </div>

    <div class="tab-content" id="returns">
      <p><%- returnsInfoDefault %></p>
    </div>

  </div>

</main>

<!-- YOU MAY ALSO LIKE -->
<% if (!user || user.role === "customer") { %>
<section class="recommend-section">
  <h2 class="recommend-title">YOU MAY ALSO LIKE</h2>

  <div class="recommend-grid">
    <% recommendations.forEach(item => { %>
      <a href="/products/<%= item.productId %>" class="recommend-card">
        <div class="rec-img-wrapper">
          <img src="<%= item.imageUrl %>" alt="<%= item.name %>">
        </div>
        <p class="rec-name"><%= item.name %></p>
        <p class="rec-price">₱<%= item.price.toLocaleString() %></p>
      </a>
    <% }) %>
  </div>
</section>
<% } %>
<!-- ======================================================================= -->
<!-- JAVASCRIPT -->
<!-- ======================================================================= -->

<script>
// SIZE SELECTOR
document.querySelectorAll(".size-option").forEach(btn => {
  btn.addEventListener("click", () => {
    if (btn.classList.contains("size-disabled")) return;

    document.querySelectorAll(".size-option").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");

    const size = btn.dataset.size;
    document.getElementById("selectedSize").value = size;

    const text = document.querySelector(".selected-size-text");
    if (text) text.textContent = "Selected size: " + size;
  });
});

// TABS
document.querySelectorAll(".product-tabs .tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".product-tabs .tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));

    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  });
});

// SHOW TOAST FUNCTION
function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.add("show");

  setTimeout(() => toast.classList.remove("show"), 1500);
}

// ADD TO CART (AJAX)
document.getElementById("addToCartForm")?.addEventListener("submit", async (e) => {
  e.preventDefault();

  const productId = document.querySelector("input[name='productId']").value;
  const size = document.querySelector("input[name='size']").value;
  const quantity = document.querySelector("input[name='quantity']").value;

  if (!size) return showToast("Please select a size first.");

  const response = await fetch("/cart/add", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Accept": "application/json"
    },
    body: JSON.stringify({ productId, size, quantity })
  });

  const result = await response.json();

  if (result.success) {
    // BOUNCE ANIMATION
    const counter = document.getElementById("navCartCount");
    if (counter) {
      counter.textContent = `(${result.cartCount})`;
      counter.classList.add("animate");
      setTimeout(() => counter.classList.remove("animate"), 450);
    }

    showToast("Added to cart!");
  } else {
    showToast(result.message || "Error adding to cart.");
  }
});

// PROCEED TO CHECKOUT BUTTON
document.getElementById("proceedCheckoutBtn")?.addEventListener("click", async () => {
  const productId = document.querySelector("input[name='productId']").value;
  const size = document.querySelector("input[name='size']").value;
  const quantity = document.querySelector("input[name='quantity']").value;

  if (!size) return showToast("Please select a size first.");

  const response = await fetch("/cart/add", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Accept": "application/json"
    },
    body: JSON.stringify({ productId, size, quantity })
  });

  const result = await response.json();

  if (result.success) {
    const counter = document.getElementById("navCartCount");
    if (counter) {
      counter.textContent = `(${result.cartCount})`;
      counter.classList.add("animate");
      setTimeout(() => counter.classList.remove("animate"), 450);
    }

    showToast("Added — Redirecting...");
    setTimeout(() => window.location.href = "/cart/checkout", 900);

  } else {
    showToast(result.message || "Unable to proceed.");
  }
});
</script>

<!-- ======================================================= -->
<!-- TOAST + CART COUNTER ANIMATIONS -->
<!-- ======================================================= -->

<style>
/* CART COUNTER BOUNCE */
#navCartCount.animate {
  animation: cartBounce 0.45s ease-out;
}

@keyframes cartBounce {
  0%   { transform: scale(1); }
  35%  { transform: scale(1.35); }
  100% { transform: scale(1); }
}

/* TOAST BOX */
#toast {
  position: fixed;
  bottom: 25px;
  left: 50%;
  transform: translateX(-50%);
  background: #000;
  color: #fff;
  padding: 12px 22px;
  border-radius: 30px;
  font-size: 0.9rem;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.4s ease, bottom 0.3s ease;
  z-index: 999999;
}

#toast.show {
  opacity: 1;
  bottom: 38px;
}

/* ADMIN SIZE TABLE */
.admin-size-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 0.95rem;
}

.admin-size-table th,
.admin-size-table td {
  padding: 10px 6px;
  text-align: left;
  border-bottom: 1px solid #ddd;
}

.admin-size-table th {
  font-weight: 600;
  background-color: #fafafa;
}

/* DISABLED SIZE BUTTON */
.size-disabled {
  opacity: .4;
  cursor: not-allowed;
  text-decoration: line-through;
  border-color: #ccc !important;
}
</style>

<!-- TOAST CONTAINER -->
<div id="toast"></div>
