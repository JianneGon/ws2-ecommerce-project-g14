<h1 class="page-title">Admin – Sales Overview</h1>

<div class="admin-reports-container">

  <!-- Simple nav / breadcrumbs -->
  <div class="report-top-links no-print">
    <a href="/products/admin/products" class="link-back">
        ← Back to Products
    </a>

    <span class="divider">|</span>

    <a href="/admin/orders" class="link-normal">
        View Orders
    </a>
</div>

  <!-- FILTERS -->
  <section class="admin-filters-section no-print">
  <h2>Filters</h2>

  <form method="GET" action="/admin/reports/sales" class="filters-flat">

    <div class="filter-field">
      <label>Start Date</label>
      <input 
        type="date"
        name="startDate"
        value="<%= 
            filters.startDate 
              ? (filters.startDate.includes('/') 
                  ? filters.startDate.split('/').reverse().join('-')
                  : filters.startDate.substring(0,10))
              : '' 
        %>"
      >
    </div>

    <div class="filter-field">
      <label>End Date</label>
      <input 
        type="date"
        name="endDate"
        value="<%= 
            filters.endDate 
              ? (filters.endDate.includes('/') 
                  ? filters.endDate.split('/').reverse().join('-')
                  : filters.endDate.substring(0,10))
              : '' 
        %>"
      >
    </div>

    <div class="filter-field">
      <label>Status</label>
      <select name="status">
        <option value="all"        <%= filters.status === 'all' ? 'selected' : '' %>>All</option>
        <option value="completed"  <%= filters.status === 'completed' ? 'selected' : '' %>>Completed</option>
        <option value="to_pay"     <%= filters.status === 'to_pay' ? 'selected' : '' %>>To Pay</option>
        <option value="to_ship"    <%= filters.status === 'to_ship' ? 'selected' : '' %>>To Ship</option>
        <option value="to_receive" <%= filters.status === 'to_receive' ? 'selected' : '' %>>To Receive</option>
        <option value="refund"     <%= filters.status === 'refund' ? 'selected' : '' %>>Refund</option>
        <option value="cancelled"  <%= filters.status === 'cancelled' ? 'selected' : '' %>>Cancelled</option>
      </select>
    </div>

    <button class="filter-apply-btn" type="submit">Apply Filters</button>
  </form>
</section>


  <!-- REPORT ACTION BUTTONS (Lesson 24 – Part 2) -->
  <section class="admin-reports-section no-print report-actions-polished">
  <h2 class="report-actions-title">Report Actions</h2>

  <div class="report-actions-grid">

    <a 
      href="/admin/reports/sales/export/daily?<%= `startDate=${filters.startDate}&endDate=${filters.endDate}&status=${filters.status}` %>"
      class="report-action-link"
    >[ Download Daily Sales ]</a>

    <a 
      href="/admin/reports/sales/export/orders?<%= `startDate=${filters.startDate}&endDate=${filters.endDate}&status=${filters.status}` %>"
      class="report-action-link"
    >[ Download Detailed Orders ]</a>

    <button 
      onclick="window.print()"
      class="report-action-link btn-as-link"
    >[ Print as PDF ]</button>

    <a href="#" id="downloadChartBtn" class="report-action-link">[ Download Chart ]</a>

    <a 
      href="/admin/reports/sales/export/monthly?<%= `startDate=${filters.startDate}&endDate=${filters.endDate}&status=${filters.status}` %>"
      class="report-action-link"
    >[ Monthly XLSX ]</a>

  </div>
</section>


  <!-- ===========================
        SUMMARY (CENTERED)
      =========================== -->
<section class="summary-centered-section">

  <h2 class="summary-title">Summary</h2>

  <% if (dailySales.length === 0) { %>

    <p class="no-summary-text">No sales data found for the selected filters.</p>

  <% } else { %>

    <div class="summary-card">

      <div class="summary-row">
        <span>Total Sales</span>
        <strong>₱<%= summary.totalSales.toLocaleString() %></strong>
      </div>

      <div class="summary-row">
        <span>Total Orders</span>
        <strong><%= summary.totalOrders %></strong>
      </div>

  <% } %>

</section>

  <!-- DAILY SALES TABLE -->
<section class="daily-sales-section">

  <h2 class="daily-sales-title">Daily Sales</h2>

  <% if (dailySales.length === 0) { %>

    <p class="no-sales-text">No daily sales found for selected filters.</p>

  <% } else { %>

    <div class="daily-table-wrapper">

      <div class="daily-table-header">
        <span>Date</span>
        <span>Total Sales</span>
        <span>Orders</span>
      </div>

      <% dailySales.forEach(day => { %>
        <div class="daily-table-row">

          <div class="col-date">
            <%= day._id %>
          </div>

          <div class="col-sales">
            ₱<%= Number(day.totalSales).toLocaleString() %>
          </div>

          <div class="col-orders">
            <%= day.orderCount %>
          </div>

        </div>
      <% }) %>

    </div>

  <% } %>

</section>

  <!-- SALES CHART -->
 <section class="admin-reports-section sales-chart-wrap">

  <h2 class="sales-chart-title">Sales Chart</h2>

  <% if (dailySales.length === 0) { %>
    <p>No chart data available.</p>
  <% } else { %>
    <div class="chart-container">
      <canvas id="salesChart" width="1600" height="900"></canvas>
    </div>
  <% } %>

</section>


</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  <% if (dailySales.length > 0) { %>

  const labels = <%- JSON.stringify(labels) %>;
  const salesData = <%- JSON.stringify(salesData) %>;

  const ctx = document.getElementById("salesChart").getContext("2d");

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Daily Sales (₱)",
        data: salesData,
        backgroundColor: "rgba(0, 85, 255, 0.25)",
        borderColor: "rgba(0, 85, 255, 1)",
        borderWidth: 2,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return "₱" + value.toLocaleString();
            },
          },
        },
      },
    },
  });

 document.getElementById("downloadChartBtn").addEventListener("click", () => {
    const canvas = document.getElementById("salesChart");
    const ctx = canvas.getContext("2d");

    // Create a temporary canvas
    const tmpCanvas = document.createElement("canvas");
    tmpCanvas.width = canvas.width;
    tmpCanvas.height = canvas.height;
    const tmpCtx = tmpCanvas.getContext("2d");

    // Fill white background
    tmpCtx.fillStyle = "#ffffff";
    tmpCtx.fillRect(0, 0, tmpCanvas.width, tmpCanvas.height);

    // Draw original chart over white background
    tmpCtx.drawImage(canvas, 0, 0);

    // Download the result
    const link = document.createElement("a");
    link.download = "sales_chart.png";
    link.href = tmpCanvas.toDataURL("image/png");
    link.click();
});

  <% } %>
</script>
