<h1 class="page-title">Admin – Products</h1>

<div class="admin-products-container">

  <!-- Success / Error Message -->
  <% if (message) { %>
    <div id="toast" class="toast <%= message.type === 'success' ? 'success' : 'error' %>">
      <%= message.text %>
    </div>
  <% } %>

  <!-- FILTER BAR -->
  <form action="/products/admin/products" method="GET" class="admin-filter-row">

    <input 
      type="text"
      id="searchName"
      name="searchName"
      placeholder="Search name..."
      value="<%= searchName || '' %>"
      class="filter-input"
    >

    <input 
      type="text"
      id="searchCategory"
      name="searchCategory"
      placeholder="Category"
      value="<%= searchCategory || '' %>"
      class="filter-input"
    >

    <div class="filter-btn-row">
      <button type="submit" class="btn-primary filter-btn">Search</button>
      <a href="/products/admin/products" class="btn-cancel filter-btn">Clear</a>
    </div>

  </form>

  <!-- HEADER ACTIONS -->
  <div class="admin-action-header">
    <a href="/products/add" class="add-product-link">
      Add New Product
    </a>
  </div>

  <div class="admin-table-wrapper">
    <table class="admin-products-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Brand</th>
          <th>Category</th>
          <th>Price</th>
          <th>Stock</th>
          <th>Created</th>
          <th style="text-align:center;">Actions</th>
        </tr>
      </thead>

      <tbody id="productsTableBody">
        <% if (products.length === 0) { %>
          <tr>
            <td colspan="7" class="no-results">No products found.</td>
          </tr>
        <% } %>

        <% products.forEach(p => { %>
          <tr>
            <!-- IMAGE + NAME -->
            <td class="product-cell">
              <img 
                src="<%= p.imageUrl %>"
                class="product-thumb"
                onerror="this.src='/images/placeholder-shoe.jpg'"
              >
              <span><%= p.name %></span>
            </td>

            <td><%= p.brand || '-' %></td>
            <td><%= p.category || '-' %></td>
            <td>₱<%= p.price.toLocaleString() %></td>
            <td><%= p.stock || 0 %></td>

            <td>
              <%= p.createdAt ? new Date(p.createdAt).toLocaleDateString() : "-" %>
            </td>

            <!-- ACTION BUTTONS -->
            <td class="product-actions">
              <a href="/products/edit/<%= p.productId %>" class="btn-action blue">Edit</a>

              <form action="/products/delete/<%= p.productId %>" method="POST" class="delete-form">
                <button type="submit" class="btn-action red delete-btn">Delete</button>
              </form>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<!-- =============================
     DELETE CONFIRMATION MODAL
============================= -->
<div id="deleteModal" class="modal-overlay hidden">
  <div class="modal-box">

    <span class="modal-close" id="closeModal">&times;</span>

    <div class="modal-icon">✖</div>

    <div class="modal-title">Are you sure?</div>

    <div class="modal-text">
      Do you really want to delete this product?<br>
      This process cannot be undone.
    </div>

    <div class="modal-buttons">
      <button class="modal-btn cancel" id="cancelDelete">Cancel</button>
      <button class="modal-btn delete" id="confirmDelete">Delete</button>
    </div>

  </div>
</div>

<!-- =============================
     SCRIPTS
============================= -->
<script>
/* ===========================
   DELETE MODAL LOGIC
=========================== */
let deleteFormToSubmit = null;

document.querySelectorAll(".delete-btn").forEach(btn => {
  btn.addEventListener("click", function(e) {
    e.preventDefault();
    deleteFormToSubmit = this.closest("form");
    document.getElementById("deleteModal").classList.remove("hidden");
    document.body.style.overflow = "hidden";
  });
});

document.getElementById("cancelDelete").onclick =
document.getElementById("closeModal").onclick = function () {
  document.getElementById("deleteModal").classList.add("hidden");
  document.body.style.overflow = "auto";
};

document.getElementById("confirmDelete").onclick = function () {
  if (deleteFormToSubmit) deleteFormToSubmit.submit();
};

/* ===========================
   TOAST AUTO SHOW/HIDE
=========================== */
const toast = document.getElementById("toast");
if (toast) {
  setTimeout(() => toast.classList.add("show"), 100);
  setTimeout(() => toast.classList.remove("show"), 4500);
}

/* ===========================
   REAL-TIME SEARCH (AJAX)
=========================== */
const nameInput = document.getElementById("searchName");
const categoryInput = document.getElementById("searchCategory");
const tableBody = document.getElementById("productsTableBody");

async function liveSearch() {
  const name = nameInput.value.trim();
  const category = categoryInput.value.trim();

  const res = await fetch(`/products/admin/search?name=${name}&category=${category}`);
  const data = await res.json();

  if (!data.success) return;

  let rows = "";

  if (data.products.length === 0) {
    rows = `<tr><td colspan="7" class="no-results">No products found.</td></tr>`;
  } else {
    data.products.forEach(p => {
      rows += `
        <tr>
          <td class="product-cell">
            <img src="${p.imageUrl}" class="product-thumb" onerror="this.src='/images/placeholder-shoe.jpg'">
            <span>${p.name}</span>
          </td>
          <td>${p.brand || "-"}</td>
          <td>${p.category || "-"}</td>
          <td>₱${p.price.toLocaleString()}</td>
          <td>${p.stock || 0}</td>
          <td>${p.createdAt ? new Date(p.createdAt).toLocaleDateString() : "-"}</td>
          <td class="product-actions">
            <a href="/products/edit/${p.productId}" class="btn-action blue">Edit</a>
            <form action="/products/delete/${p.productId}" method="POST" class="delete-form">
              <button type="submit" class="btn-action red delete-btn">Delete</button>
            </form>
          </td>
        </tr>
      `;
    });
  }

  tableBody.innerHTML = rows;

  // Re-bind delete modal events for new rows
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.addEventListener("click", function(e) {
      e.preventDefault();
      deleteFormToSubmit = this.closest("form");
      document.getElementById("deleteModal").classList.remove("hidden");
      document.body.style.overflow = "hidden";
    });
  });
}

// Trigger live search on both inputs
nameInput.addEventListener("input", liveSearch);
categoryInput.addEventListener("input", liveSearch);

</script>
